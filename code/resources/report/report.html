<html>
<head>
  <title>Report</title>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,300,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=PT+Serif:400,700,400italic' rel='stylesheet' type='text/css'>
  <link href='https://netdna.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.css' rel='stylesheet' type='text/css'>
  <link href='https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css' rel='stylesheet' type='text/css'>
  <link href='metricsgraphics.css' rel='stylesheet' type='text/css'>
  <style>
    #canvas {
      padding: 20px;
      text-align: center;
    }

    .trace {
      margin-top: 10px;
    }

    .footer {
      text-align: center;
      padding-top: 10px;
      padding-bottom: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="row">
      <div class="col-md-12">
        <h1>Lojjing report</h1>
      </div>
    </div>
    <div class="row">
      <div class="col-md-12">
        <div id="canvas"></div>
      </div>
    </div>
    <div class="row">
      <div class="col-md-12">
        <div id="details"></div>
      </div>
    </div>
    <div class="row">
      <div class="col-md-12">
        <footer class="footer">Made with <3 by Lojjing</footer>
      </div>
    </div>
  </div>
<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.0/d3.min.js' charset='utf-8'></script>
<script src='metricsgraphics.min.js'></script>
<script src='underscore.min.js'></script>
<script src='mustache.min.js'></script>
<script id="tpl-details" type="x-tmpl-mustache">

  <table class="table">
    <tr>
      <th>Count</th>
      <th>Message</th>
      <th>Signature</th>
    </tr>
    {{#errors}}
    <tr>
      <td>{{count}}</td>
      <td class="message">
        <div>
          {{message}}
          <button class="btn btn-xs btn-default action-expand">Expand</button>
          <button class="btn btn-xs btn-default action-collapse">Collapse</button>
        </div>
        <pre class="trace">
          <code>{{trace}}</code>
        </pre>
      </td>
      <td>{{signature}}</td>
    </tr>
    {{/errors}}
  </table>

</script>
<script>
  var Exception = function(e) {
    // .action-expand .action-collapse .trace
    this.trace = $('.trace', e);

    $('.action-expand', e).click(this, function(e){
      e.data.expand();
    });

    $('.action-collapse', e).click(this, function(e){
      e.data.collapse();
    });
  };

  Exception.prototype.expand = function() {
    this.trace.show();
  };

  Exception.prototype.collapse = function() {
    this.trace.hide();
  };

  d3.json('report.json', function(json) {
    var data = [];
    var i;

    for (i = 0; i < json.data.length; i++) {
      data[i] = MG.convert.date(json.data[i], 'date');
    }

    MG.data_graphic({
      title: "All errors",
      description: "Records in APP_LOG",
      data: data,
      width: 800,
      height: 300,
      right: 100,
      target: '#canvas',
      legend: _.pluck(json.headers, 'signature'),
      x_accessor: 'date',
      y_accessor: 'value'
    });

    $('#details').html(Mustache.render($('#tpl-details').html(), {errors: json.headers}));

    $('#details td.message').each(function(index, el){
      var exception = new Exception(el);
      exception.collapse();
    });
  });
  </script>
</body>
</html>